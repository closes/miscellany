#!/usr/bin/env python3
import numpy as np
from seawater import ptmp as sw_ptmp

def pspi(s0,t0,p0,pr=0):
    """ Calculate potential spicity of Huang et al. 2018
    s0: salinity (range 10-40)
    t0: temperature (range -2-40)
    p0: pressure
    pr: reference pressure, must be one of:
        0, 500, 1000, 2000, 3000, 4000, 5000
        (default value is 0)
    """

    b0=[-0.0153300841099570,  0.0231895932005821, -0.0381875052767683,
     0.1592557110880523,  0.0117243711053217, -0.0718653451824515,
     0.5318847880659945,  0.0779892741936997,  0.0035239803459740,
     0.1201750871344241,  1.3042441933369422,  0.3565702465910514,
     0.0369715779948543,  0.0000800204884482, -1.0632874635722567,
     1.5631387572647097,  0.0089892799984272, -0.2183716842447750,
    -0.0281177888020686, -0.0013045569983979,  4.2176434025093101,
     4.6913470773126011,  2.5592069121111529,  2.3758221464778653,
     0.4911933538650005,  0.0298538964966979,  0.0016225085963151,
    -9.3974242130945633, -4.3905044464512457,  1.5070608294125327,
    -5.5501502356153471, -3.2062353090836222, -0.3928957921270134,
    -0.0316989049793372, -0.0017416060933394, 13.2462318893758850,
    19.6295852797249890, -3.3083205188612457,  5.8386677663053890,
     7.1937016736312600,  2.1546104550028686,  0.0996470664237621,
     0.0297021530229794,  0.0015361697390362, -9.7346615514331560,
   -18.8955171635407950,  5.9733854291477746,  0.3783949644377257,
    -5.8999876151527202, -3.8573920011834675, -0.6665314984311493,
     0.0358514745101728, -0.0172904156245161, -0.0006456633104225,
     3.5001447334308131, 13.0257424609277040,  1.0828755101246170,
    -0.4450532843399354,  0.1809352509285085,  2.2432052797602897,
     0.6072423205728305,  0.1123186585718297, -0.0197441171553408,
     0.0047837338370827,  0.0001058068718505]

    b500=[-0.0170897680043427,  0.0393980201464236, -0.0322181007256357,
     0.2465779702237007,  0.0196951777573940, -0.0340256035131898,
     0.7548983242984324,  0.1209959405758238,  0.0060760492664506,
     0.1186565896130432,  1.6463999712553303,  0.4709774375654697,
     0.0526748524725206, -0.0000370598201769, -0.4596327796294014,
     2.0379216819038586,  0.1518525728129951, -0.1916555843387189,
    -0.0369618601778135, -0.0017944795273568,  2.3546809284893735,
     3.8759296980147950,  2.9104105624114198,  2.4389794658940893,
     0.5032009345452483,  0.0469302584258510,  0.0018343354907595,
    -4.7626772767589456, -0.4809814106641089,  0.8409503724739962,
    -5.3772643134946145, -3.2051475990896465, -0.4169693314118330,
    -0.0603545798915546, -0.0016126506399402,  7.0904800397810774,
    10.4358091142353400, -1.7098551480956530,  5.5920785736934606,
     7.0190653686553324,  2.1137399496512042,  0.1209557483696642,
     0.0567464281690320,  0.0014241231794942, -5.1119719051196704,
    -8.9361269179306273,  4.4208404799781595,  0.3638415547771647,
    -5.5795643245841617, -3.8205371549694354, -0.6235916487154449,
     0.0210332177260958, -0.0298501212939195, -0.0005407915757731,
     1.9713169360784892,  7.2023488988739333,  0.8751781695325449,
    -0.5576302851748650,  0.3120792130214046,  2.0030004797305798,
     0.6781634724458714,  0.0886131123332279, -0.0125258948868738,
     0.0071733806912177,  0.0000764047696809]

    b1000=[-0.0152796296361631,  0.0634840156952664, -0.0134499436502916,
     0.3629264124823363,  0.0313022734302577,  0.0242237811432335,
     1.0187474687702429,  0.1773719831098710,  0.0099091613026001,
     0.1691235290636256,  1.9985805250978699,  0.5994233243005691,
     0.0730579249356983, -0.0002047748310705, -0.0636584894370516,
     2.3904585542604715,  0.3293130608600984, -0.1463442323972841,
    -0.0465947637412494, -0.0027639826215597,  1.3292646659965168,
     3.4267820352004521,  3.1062630355985164,  2.4107785782524207,
     0.4993011197582294,  0.0643809383043240,  0.0028493345644662,
    -2.1625538261755337,  1.4239302709720265,  0.3955622178527191,
    -5.0171900524765860, -3.0742800375630850, -0.4399256184470501,
    -0.0898904479010334, -0.0025567347493471,  3.6477127928388744,
     5.3206703060792782, -0.6919221499024630,  5.2429080677277975,
     6.5662197491194361,  2.0008960637703823,  0.1506262108518998,
     0.0841439315207993,  0.0023309531864595, -2.5435478726615646,
    -3.6853080297903333,  3.3399207041986787,  0.2340886383835905,
    -5.0938462922172238, -3.6222070014123475, -0.5783801858129577,
     0.0026567274608136, -0.0420964556511797, -0.0009336622148579,
     1.0790284792918607,  3.8647869734498403,  0.5916969122340452,
    -0.5168326465476724,  0.3366904017124426,  1.7730130282701744,
     0.6905225982068610,  0.0769487350865983, -0.0057920650733116,
     0.0094835221955953,  0.0001497191916782]

    b2000=[0.0091417081396188,  0.1452955939511846,  0.0770118742407799,
     0.6969572944033762,  0.0689590943556884,  0.2052671884421505,
     1.6493343937052261,  0.3325382924550207,  0.0232279929569938,
     0.3549428710544382,  2.6588535884495310,  0.8793293294099017,
     0.1312861610175250, -0.0013913144468472,  0.3773746884403297,
     2.8097805261579611,  0.7468352594494717,  0.0054925826410827,
    -0.0734726572370883, -0.0054221218460469,  0.4925650505594068,
     2.8949682015867260,  3.0445208914586348,  2.0745903040460929,
     0.4117184896548931,  0.1122163176449262,  0.0057235041280763,
     0.0013733957773534,  2.3823825552243458, -0.0525449092789445,
    -3.8209684066062266, -2.4373733447193815, -0.4279490589511414,
    -0.1729231959436325, -0.0054925819960008,  0.7046929492037855,
     0.9344987275258222,  0.2969191013375820,  4.2113960509310218,
     5.0169760698229204,  1.5324604234032757,  0.1856791756573022,
     0.1624044356549286,  0.0054301380642790, -0.3968294706581253,
     0.3054017331910741,  1.9252531003555615, -0.0877226648348107,
    -3.8257373677218180, -2.8440753233870275, -0.4352813145427408,
    -0.0234420265213581, -0.0779105435940676, -0.0023438751225325,
     0.2672395631765803,  0.8666719628347207,  0.0762680268014655,
    -0.3034474267877694,  0.2563735218432175,  1.3041416229218938,
     0.5919917285182480,  0.0650718724250279,  0.0034357714409026,
     0.0166075264216577,  0.0004196791282721]

    b3000=[0.0829921187927801,  0.2940570154114436,  0.2578885740581015,
     1.1894395862680167,  0.1314295760613576,  0.4611757366676674,
     2.3800776316930210,  0.5404506032664056,  0.0479418747927825,
     0.5717539343370265,  3.1802290008980481,  1.1532217395761863,
     0.2188291802224379, -0.0050117634983723,  0.5622738524648018,
     2.9410140059929866,  1.1894880958689704,  0.2288565966419371,
    -0.1212819030176276, -0.0100180336081773,  0.2901642712632136,
     2.4088812196170579,  2.4138569910554297,  1.3292134446557626,
     0.1974376712015098,  0.1877955201148325,  0.0120583403113963,
     0.4631123222997070,  1.8683667712558829, -0.1210250841869803,
    -2.0803807862499175, -1.2636083847943982, -0.3148043221734607,
    -0.2973971834277590, -0.0127984759544481, -0.0898243185029628,
    -0.1895452576574909,  0.5950558016225140,  2.7675605470131655,
     2.7661066543570692,  0.6444098115446179,  0.1834064684876638,
     0.2771091355143084,  0.0128028706653020,  0.1443158973235865,
     0.9521965669200102,  0.9250791797991642, -0.3374875218359553,
    -2.3588120767435465, -1.6314981684460832, -0.1318487241192919,
    -0.0462475142345925, -0.1293713685555110, -0.0057611757126841,
     0.0124346887668264, -0.0590204503858635, -0.2102399523640291,
    -0.1258060204210724,  0.1544912306800221,  0.7994584093319075,
     0.3694396473607853,  0.0318541718233533,  0.0132853113210982,
     0.0266429967409608,  0.0010890850132457]

    b4000=[0.2370002318651782,  0.5381589430593935,  0.5387332509583285,
     1.8367328878855200,  0.2190076533245268,  0.7527436638782535,
     3.1045464711421662,  0.7710129605215795,  0.0894202672607398,
     0.7482044198379578,  3.4607088826442109,  1.3769400814627872,
     0.3395747291647098, -0.0144359439344768,  0.5845814889160134,
     2.7749098715576741,  1.4552709439955931,  0.4077830363517979,
    -0.2056660897277933, -0.0174856389508560,  0.2872973066717510,
     1.8522445541076458,  1.5986862566228270,  0.6203915955318132,
     0.0190869991558108,  0.2957002215280178,  0.0264031095282703,
     0.3015680656488169,  1.0062127553156917, -0.0100938790000904,
    -0.6693418077745867, -0.2585731993743720, -0.2467721345005530,
    -0.4497985949554598, -0.0310783369635849, -0.0886553875979514,
    -0.0847613325636572,  0.4843116193937502,  1.4496276135138042,
     0.9628824750866357, -0.1306978534604700,  0.2138998039833219,
     0.4085072429345181,  0.0302894687290413,  0.1128438575883403,
     0.4713019340266491,  0.2885042964220720, -0.3231744990167486,
    -1.2269978401137021, -0.6365606225666358,  0.1550364472972289,
    -0.0836582108559878, -0.1851024503722259, -0.0140010791448744,
    -0.0197718505975002, -0.1262118069000105, -0.1611870955479239,
    -0.0559238641448582,  0.0930198972851187,  0.4090199622334122,
     0.1744755449159634, -0.0099361780755030,  0.0262336469312906,
     0.0369115755434412,  0.0027324983705219]

    b5000=[0.5137108656598407,  0.9272118361918661,  0.9237574106913609,
     2.6488771120490111,  0.3203064640437509,  1.0396844175235527,
     3.7457447497414229,  0.9682339828436751,  0.1598527167686548,
     0.8449949476579887,  3.4769854850202657,  1.4949967184869493,
     0.5045073446974311, -0.0450435727340453,  0.5229812333095537,
     2.3513000303991149,  1.3920139847466240,  0.4511115607461256,
    -0.3670587255997733, -0.0134242433773768,  0.2558677222788089,
     1.2471581703858128,  0.9523495152661099,  0.3074440965302491,
     0.0114939329849617,  0.4812484081251261,  0.0324515116106133,
     0.1114887314469300,  0.4173385012799878,  0.0228174936852482,
    -0.0826327488562640,  0.0403434422478097, -0.3518776929784379,
    -0.6675432305132891, -0.0432864238607635,  0.0016930899000822,
     0.0437619774486480,  0.2221900544906569,  0.6442939140253805,
     0.1692791407743907, -0.3308066513013085,  0.3363847718265349,
     0.5811985675973489,  0.0456362418587216,  0.0207294612505628,
     0.0781348649106775,  0.0398163605209567, -0.1604848102578897,
    -0.5895951930360275, -0.1754460644090687,  0.2209529745724252,
    -0.1407328439846876, -0.2569291682263102, -0.0218758921025089,
    -0.0047991381246822, -0.0292812892190461, -0.0342521306783400,
    -0.0216511237754927,  0.0494919851708555,  0.1980313253516407,
     0.0745912573742710, -0.0211661411562899,  0.0380984000054902,
     0.0500761805296033,  0.0043823530255001]

    # deal with case where arrays are single numbers
    if ((type(s0) is float) and (type(t0) is float)):
        s0=np.array([s0])
        t0=np.array([t0])
        p0=np.array([p0])
        
    if pr == 0:
        b = b0
        spi0 = 3.446776934
    elif pr == 500:
        b = b500
        spi0 = 1.705024348
    elif pr == 1000:
        b = b1000
        spi0 = 1.367927975
    elif pr == 2000:
        b = b2000
        spi0 = 1.513725542
    elif pr == 3000:
        b = b3000
        spi0 = 1.916367274
    elif pr == 4000:
        b = b4000
        spi0 = 2.428307519
    elif pr == 5000:
        b = b5000
        spi0 = 3.091480510
    else:
        raise ValueError('Aborting: permitted reference pressure values are 0, '+\
        '500, 1000, 2000, 3000, 4000 or 5000 only')

    if ((s0 < 10).any() or (s0 > 40).any()):
        raise ValueError('Aborting: salinity out of bounds (10 < S < 40)')

    if ((t0 < -2).any() or (t0 > 40).any()):
        raise ValueError('Aborting: temperature out of bounds (-2 < T < 40)')

    t00 = sw_ptmp(s0,t0,p0,pr)
    s = (s0 - 10)/30.0
    t = (t00 + 2)/42.0

    spow={}
    tpow={}
    for n in range(1,11):
        spow['s'+str(n)]=s**n
        tpow['t'+str(n)]=t**n

    sp=(b[0]*s) + (b[1]*t) + (b[2]*spow['s2']) + (b[3]*s*t) \
        + (b[4]*tpow['t2'])+ (b[5]*spow['s3']) + \
        (b[6]*spow['s2']*t) + (b[7]*s*tpow['t2']) + \
        (b[8]*tpow['t3'])+ (b[9]*spow['s4']) + \
        (b[10]*spow['s3']*t) + \
        (b[11]*spow['s2']*tpow['t2']) + \
        (b[12]*s*tpow['t3']) + (b[13]*tpow['t4']) + \
        (b[14]*spow['s5']) + (b[15]*spow['s4']*t) + \
        (b[16]*spow['s3']*tpow['t2']) + \
        (b[17]*spow['s2']*tpow['t3']) + \
        (b[18]*s*tpow['t4']) + (b[19]*tpow['t5']) + \
        (b[20]*spow['s6']) + (b[21]*spow['s5']*t) + \
        (b[22]*spow['s4']*tpow['t2']) + \
        (b[23]*spow['s3']*tpow['t3']) + \
        (b[24]*spow['s2']*tpow['t4']) + \
        (b[25]*s*tpow['t5'] ) + (b[26]*tpow['t6']) + \
        (b[27]*spow['s7']) + (b[28]*spow['s6']*t) + \
        (b[29]*spow['s5']*tpow['t2']) + \
        (b[30]*spow['s4']*tpow['t3']) + \
        (b[31]*spow['s3']*tpow['t4']) + \
        (b[32]*spow['s2']*tpow['t5']) + \
        (b[33]*s*tpow['t6']) + (b[34]*tpow['t7']) + \
        (b[35]*spow['s8']) + (b[36]*spow['s7']*t) + \
        (b[37]*spow['s6']*tpow['t2']) + \
        (b[38]*spow['s5']*tpow['t3']) + \
        (b[39]*spow['s4']*tpow['t4']) + \
        (b[40]*spow['s3']*tpow['t5']) + \
        (b[41]*spow['s2']*tpow['t6']) + \
        (b[42]*s*tpow['t7']) + (b[43]*tpow['t8']) + \
        (b[44]*spow['s9']) + (b[45]*spow['s8']*t) + \
        (b[46]*spow['s7']*tpow['t2']) + \
        (b[47]*spow['s6']*tpow['t3']) + \
        (b[48]*spow['s5']*tpow['t4']) + \
        (b[49]*spow['s4']*tpow['t5']) + \
        (b[50]*spow['s3']*tpow['t6']) + \
        (b[51]*spow['s2']*tpow['t7']) + \
        (b[52]*s*tpow['t8']) + (b[53]*tpow['t9']) + \
        (b[54]*spow['s10']) + (b[55]*spow['s9']*t) + \
        (b[56]*spow['s8']*tpow['t2']) + \
        (b[57]*spow['s7']*tpow['t3']) + \
        (b[58]*spow['s6']*tpow['t4']) + \
        (b[59]*spow['s5']*tpow['t5']) + \
        (b[60]*spow['s4']*tpow['t6']) + \
        (b[61]*spow['s3']*tpow['t7']) + \
        (b[62]*spow['s2']*tpow['t8']) + \
        (b[63]*s*tpow['t9']) + (b[64]*tpow['t10'])
    spi = sp - spi0
    return spi
